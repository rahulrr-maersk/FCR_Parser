name: IssueOps - FCR Processing

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  issues: write
  contents: read

jobs:
  process-fcr:
    if: contains(github.event.issue.labels.*.name, 'fcr-processing')
    runs-on: ubuntu-latest
    
    steps:
      - name: Acknowledge Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Processing Started
              
Your FCR file(s) are being processed. This typically takes 2-5 minutes.

**Status:** Processing in progress...

Results will be posted here automatically when complete.`
            });
            
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              content: 'eyes'
            });
      
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Extract Files
        id: extract-files
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // GitHub attachment URL pattern for CSV and XLSX files
            const urlPattern = /https:\/\/github\.com\/[^\/]+\/[^\/]+\/files\/\d+\/[^\s)]+\.(csv|xlsx)/gi;
            const matches = issueBody.match(urlPattern);
            
            if (!matches || matches.length === 0) {
              core.setFailed('No files found. Please attach at least one CSV or XLSX file to this issue.');
              return;
            }
            
            console.log(`Found ${matches.length} file(s)`);
            
            // Store all URLs as JSON array
            core.setOutput('csv_urls', JSON.stringify(matches));
            core.setOutput('file_count', matches.length);
      
      - name: Download Files
        run: |
          mkdir -p Input
          
          # Parse JSON array of URLs
          echo '${{ steps.extract-files.outputs.csv_urls }}' | jq -r '.[]' | while read url; do
            filename=$(basename "$url")
            echo "Downloading: $filename"
            curl -L -o "Input/$filename" "$url"
          done
          
          echo ""
          echo "Downloaded files:"
          ls -lh Input/
      
      - name: Restore Dependencies
        run: dotnet restore
      
      - name: Build Application
        run: dotnet build --configuration Release --no-restore
      
      - name: Run FCR Parser
        env:
          AI__GROQKEY: ${{ secrets.AI__GROQKEY }}
          AI__GEMINIKEY: ${{ secrets.AI__GEMINIKEY }}
          AI__CEREBRASKEY: ${{ secrets.AI__CEREBRASKEY }}
          AI__MISTRALKEY: ${{ secrets.AI__MISTRALKEY }}
          AI__DEEPSEEKKEY: ${{ secrets.AI__DEEPSEEKKEY }}
        run: |
          dotnet run --project FcrParser/FcrParse.csproj --configuration Release
      
      - name: Prepare Output Files for Upload
        id: prepare-outputs
        run: |
          # Create a summary of processed files
          echo "## Processing Results" > summary.md
          echo "" >> summary.md
          echo "**Files Processed:** ${{ steps.extract-files.outputs.file_count }}" >> summary.md
          echo "**Completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> summary.md
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "" >> summary.md
          
          # Process each output file
          for json_file in Output/*.json; do
            if [ -f "$json_file" ]; then
              base_name=$(basename "$json_file" .json)
              txt_file="Output/${base_name}.txt"
              
              echo "### ${base_name}" >> summary.md
              echo "" >> summary.md
              
              # Add JSON output as collapsible section
              echo "<details>" >> summary.md
              echo "<summary>JSON Output</summary>" >> summary.md
              echo "" >> summary.md
              echo '```json' >> summary.md
              cat "$json_file" >> summary.md
              echo "" >> summary.md
              echo '```' >> summary.md
              echo "</details>" >> summary.md
              echo "" >> summary.md
              
              # Add TXT output as collapsible section
              if [ -f "$txt_file" ]; then
                echo "<details>" >> summary.md
                echo "<summary>Text Output</summary>" >> summary.md
                echo "" >> summary.md
                echo '```' >> summary.md
                cat "$txt_file" >> summary.md
                echo "" >> summary.md
                echo '```' >> summary.md
                echo "</details>" >> summary.md
                echo "" >> summary.md
              fi
              
              echo "---" >> summary.md
              echo "" >> summary.md
            fi
          done
          
          # Add download link for artifacts
          echo "### Download Files" >> summary.md
          echo "" >> summary.md
          echo "All output files are available as artifacts: [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> summary.md
      
      - name: Upload Output Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fcr-outputs-issue-${{ github.event.issue.number }}
          path: |
            Output/
            Cleaned/
          retention-days: 30
      
      - name: Post Results to Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
            
            // Add success reaction
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              content: 'rocket'
            });
            
            // Close the issue automatically
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });
      
      - name: Post Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const errorMsg = `## Processing Failed

            **Timestamp:** ${new Date().toUTCString()}

            **Possible causes:**
            - Invalid CSV file format
            - File corruption or size exceeds limit
            - Temporary AI service unavailability

            **Troubleshooting:**
            1. Review [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details
            2. Verify CSV file formatting
            3. Retry upload or contact support`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: errorMsg
            });
            
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              content: 'confused'
            });
